name: Build and Release

on:
  push:
    branches:
      - main
    tags:
      - '*.*.*'
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/**'
      - '!.github/workflows/build.yml'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.0.0)'
        required: false
        default: ''

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Inject build info (commit SHA)
        run: npm run inject-build-info

      - name: Inject OAuth credentials
        run: node scripts/inject-oauth-credentials.js
        env:
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          BOX_CLIENT_ID: ${{ secrets.BOX_CLIENT_ID }}
          BOX_CLIENT_SECRET: ${{ secrets.BOX_CLIENT_SECRET }}

      - name: Build Linux packages
        run: npm run package:linux
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-builds
          path: |
            release/*.AppImage
            release/*.deb
            release/*.rpm
          retention-days: 5

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Inject build info (commit SHA)
        run: npm run inject-build-info

      - name: Inject OAuth credentials
        run: node scripts/inject-oauth-credentials.js
        env:
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          BOX_CLIENT_ID: ${{ secrets.BOX_CLIENT_ID }}
          BOX_CLIENT_SECRET: ${{ secrets.BOX_CLIENT_SECRET }}

      - name: Build Windows package
        run: npm run package:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-builds
          path: release/*.exe
          retention-days: 5

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Inject build info (commit SHA)
        run: npm run inject-build-info

      - name: Inject OAuth credentials
        run: node scripts/inject-oauth-credentials.js
        env:
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          BOX_CLIENT_ID: ${{ secrets.BOX_CLIENT_ID }}
          BOX_CLIENT_SECRET: ${{ secrets.BOX_CLIENT_SECRET }}

      - name: Build macOS packages
        run: npm run package:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-builds
          path: release/*.zip
          retention-days: 5

  release:
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    if: success()
    permissions:
      contents: write
    outputs:
      version: ${{ steps.package-version.outputs.version }}
      release_url: ${{ steps.create-release.outputs.url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from package.json
        id: package-version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$VERSION" >> $GITHUB_OUTPUT

      - name: Check if tag exists
        id: check-tag
        run: |
          if git rev-parse "${{ steps.package-version.outputs.version }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create and push tag
        if: steps.check-tag.outputs.exists == 'false' && github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.package-version.outputs.version }}" -m "Release ${{ steps.package-version.outputs.version }}"
          git push origin "${{ steps.package-version.outputs.version }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Create Release
        id: create-release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.package-version.outputs.version }}
          name: Marix ${{ steps.package-version.outputs.version }}
          files: |
            artifacts/linux-builds/*
            artifacts/windows-builds/*
            artifacts/macos-builds/*
          draft: false
          prerelease: false
          make_latest: true
          generate_release_notes: false
          body: |
            ## Marix SSH Client ${{ steps.package-version.outputs.version }}
            
            ### üîê Build Verification
            
            | Property | Value |
            |----------|-------|
            | **Commit SHA** | `${{ github.sha }}` |
            | **Short SHA** | `${{ github.sha }}` |
            | **Build Run** | [#${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
            | **Build Time** | ${{ github.event.head_commit.timestamp || 'N/A' }} |
            
            > ‚ÑπÔ∏è You can verify the commit SHA in the app: **Settings ‚Üí About ‚Üí Build Info**
            
            ### Downloads
            | Platform | File | Supported OS |
            |----------|------|--------------|
            | **Linux** | AppImage, DEB, RPM | Ubuntu 18.04+, Debian 10+, Fedora 32+ |
            | **Windows** | EXE installer | Windows 10/11 |
            | **macOS** | ZIP (Universal) | macOS 10.15+ (Intel & Apple Silicon) |
            
            ---
            
            üìã **[View Full Changelog](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)**
            üîí **[Security Documentation](https://github.com/${{ github.repository }}/blob/main/SECURITY.md)**
            üí¨ **[Join Our Discord](https://discord.gg/KSenHkCtN6)**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # DISCORD NOTIFICATION - Posts to Discord after release
  # ============================================
  notify-discord:
    needs: [release]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Read CHANGELOG.md
        id: changelog
        run: |
          VERSION="${{ needs.release.outputs.version }}"
          
          # Parse CHANGELOG.md to extract current version's changes
          node << 'SCRIPT'
          const fs = require('fs');
          
          const version = process.env.VERSION;
          const changelog = fs.readFileSync('CHANGELOG.md', 'utf-8');
          const lines = changelog.split('\n');
          
          let inCurrentVersion = false;
          let currentSection = null;
          const sections = { added: [], fixed: [], changed: [], security: [] };
          
          for (const line of lines) {
            // Check for version header
            if (line.match(/^##\s+\[/)) {
              if (inCurrentVersion) break; // Stop at next version
              if (line.includes(`[${version}]`)) {
                inCurrentVersion = true;
              }
              continue;
            }
            
            if (!inCurrentVersion) continue;
            
            // Detect section headers
            if (line.match(/^###\s+Added/i)) currentSection = 'added';
            else if (line.match(/^###\s+Fixed/i)) currentSection = 'fixed';
            else if (line.match(/^###\s+Changed/i)) currentSection = 'changed';
            else if (line.match(/^###\s+Security/i)) currentSection = 'security';
            else if (currentSection && line.trim().startsWith('-')) {
              // Clean up the line - remove markdown bold and file references
              let cleaned = line.trim()
                .replace(/\*\*([^*]+)\*\*/g, '$1')  // Remove bold
                .substring(0, 100);  // Limit length
              sections[currentSection].push(cleaned);
            }
          }
          
          // Format output (limit items per section)
          const added = sections.added.slice(0, 5).join('\\n') || 'No new features';
          const fixed = sections.fixed.slice(0, 3).join('\\n') || 'No bug fixes';
          const changed = sections.changed.slice(0, 3).join('\\n') || 'No changes';
          const security = sections.security.slice(0, 2).join('\\n') || 'No security updates';
          
          // Write to GITHUB_OUTPUT
          const output = `added<<EOF\n${added}\nEOF\nfixed<<EOF\n${fixed}\nEOF\nchanged<<EOF\n${changed}\nEOF\nsecurity<<EOF\n${security}\nEOF\n`;
          fs.appendFileSync(process.env.GITHUB_OUTPUT, output);
          SCRIPT
        env:
          VERSION: ${{ needs.release.outputs.version }}

      - name: Post to Discord Announcements
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_ANNOUNCEMENTS }}
          VERSION: ${{ needs.release.outputs.version }}
          REPO: ${{ github.repository }}
        run: |
          # Pre-compute date values to avoid shell escaping issues
          RELEASE_DATE=$(date -u '+%Y-%m-%d %H:%M UTC')
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          # Escape special characters for JSON - use heredoc to avoid quote issues
          ADDED=$(cat <<'EOFADDED'
          ${{ steps.changelog.outputs.added }}
          EOFADDED
          )
          ADDED=$(echo "$ADDED" | sed 's/"/\\"/g' | tr '\n' ' ' | sed 's/  */ /g')
          
          FIXED=$(cat <<'EOFFIXED'
          ${{ steps.changelog.outputs.fixed }}
          EOFFIXED
          )
          FIXED=$(echo "$FIXED" | sed 's/"/\\"/g' | tr '\n' ' ' | sed 's/  */ /g')
          
          CHANGED=$(cat <<'EOFCHANGED'
          ${{ steps.changelog.outputs.changed }}
          EOFCHANGED
          )
          CHANGED=$(echo "$CHANGED" | sed 's/"/\\"/g' | tr '\n' ' ' | sed 's/  */ /g')
          
          SECURITY=$(cat <<'EOFSECURITY'
          ${{ steps.changelog.outputs.security }}
          EOFSECURITY
          )
          SECURITY=$(echo "$SECURITY" | sed 's/"/\\"/g' | tr '\n' ' ' | sed 's/  */ /g')
          
          # Use a temp file for the JSON payload to avoid escaping issues
          cat > /tmp/discord_payload.json << EOFPAYLOAD
          {
            "content": "# üéâ Marix v${VERSION} Released!\n\nA new version of Marix SSH Client is now available!\n\n---",
            "embeds": [{
              "title": "üì¶ What's New in v${VERSION}",
              "description": "*Released: ${RELEASE_DATE}*",
              "color": 5814783,
              "fields": [
                {"name": "‚ú® Added", "value": "${ADDED}", "inline": false},
                {"name": "üêõ Fixed", "value": "${FIXED}", "inline": false},
                {"name": "üîÑ Changed", "value": "${CHANGED}", "inline": false},
                {"name": "üîí Security", "value": "${SECURITY}", "inline": false}
              ],
              "footer": {"text": "Marix - Your credentials never leave your device üîê"},
              "timestamp": "${TIMESTAMP}",
              "url": "https://github.com/${REPO}/releases/tag/${VERSION}"
            },
            {
              "title": "üì• Download Now",
              "color": 3066993,
              "fields": [
                {"name": "ü™ü Windows", "value": "[Download EXE](https://github.com/${REPO}/releases/download/${VERSION}/Marix.Setup.${VERSION}.exe)", "inline": true},
                {"name": "üçé macOS Intel", "value": "[Download ZIP](https://github.com/${REPO}/releases/download/${VERSION}/Marix-${VERSION}-mac.zip)", "inline": true},
                {"name": "üçé macOS ARM", "value": "[Download ZIP](https://github.com/${REPO}/releases/download/${VERSION}/Marix-${VERSION}-arm64-mac.zip)", "inline": true},
                {"name": "üêß Linux AppImage", "value": "[Download](https://github.com/${REPO}/releases/download/${VERSION}/Marix-${VERSION}.AppImage)", "inline": true},
                {"name": "üêß Linux DEB", "value": "[Download](https://github.com/${REPO}/releases/download/${VERSION}/marix_${VERSION}_amd64.deb)", "inline": true},
                {"name": "üêß Linux RPM", "value": "[Download](https://github.com/${REPO}/releases/download/${VERSION}/marix-${VERSION}.x86_64.rpm)", "inline": true}
              ],
              "footer": {"text": "View full release on GitHub"},
              "url": "https://github.com/${REPO}/releases/tag/${VERSION}"
            }]
          }
          EOFPAYLOAD
          
          curl -H "Content-Type: application/json" -X POST -d @/tmp/discord_payload.json $DISCORD_WEBHOOK

      - name: Post to Discord Changelog
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_CHANGELOG }}
          VERSION: ${{ needs.release.outputs.version }}
          REPO: ${{ github.repository }}
        run: |
          # Pre-compute date values
          RELEASE_DATE=$(date -u '+%Y-%m-%d %H:%M UTC')
          
          # Escape special characters using heredoc
          ADDED=$(cat <<'EOFADDED'
          ${{ steps.changelog.outputs.added }}
          EOFADDED
          )
          ADDED=$(echo "$ADDED" | sed 's/"/\\"/g' | tr '\n' ' ' | sed 's/  */ /g')
          
          FIXED=$(cat <<'EOFFIXED'
          ${{ steps.changelog.outputs.fixed }}
          EOFFIXED
          )
          FIXED=$(echo "$FIXED" | sed 's/"/\\"/g' | tr '\n' ' ' | sed 's/  */ /g')
          
          CHANGED=$(cat <<'EOFCHANGED'
          ${{ steps.changelog.outputs.changed }}
          EOFCHANGED
          )
          CHANGED=$(echo "$CHANGED" | sed 's/"/\\"/g' | tr '\n' ' ' | sed 's/  */ /g')
          
          SECURITY=$(cat <<'EOFSECURITY'
          ${{ steps.changelog.outputs.security }}
          EOFSECURITY
          )
          SECURITY=$(echo "$SECURITY" | sed 's/"/\\"/g' | tr '\n' ' ' | sed 's/  */ /g')
          
          # Use temp file to avoid escaping issues
          cat > /tmp/discord_changelog.json << EOFPAYLOAD
          {
            "embeds": [{
              "title": "üì¶ Version ${VERSION}",
              "description": "*Released: ${RELEASE_DATE}*",
              "color": 3447003,
              "fields": [
                {"name": "‚ú® Added", "value": "${ADDED}", "inline": false},
                {"name": "üêõ Fixed", "value": "${FIXED}", "inline": false},
                {"name": "üîÑ Changed", "value": "${CHANGED}", "inline": false},
                {"name": "üîí Security", "value": "${SECURITY}", "inline": false}
              ],
              "footer": {"text": "View full changelog on GitHub"},
              "url": "https://github.com/${REPO}/releases/tag/${VERSION}"
            }]
          }
          EOFPAYLOAD
          
          curl -H "Content-Type: application/json" -X POST -d @/tmp/discord_changelog.json $DISCORD_WEBHOOK

      - name: Discord Notification Status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Discord notifications sent successfully!"
          else
            echo "‚ö†Ô∏è Discord notification may have failed. Check webhook configuration."
          fi
